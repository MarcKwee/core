id: LoadUser
steps:

# The Bearer token should be passed as Authorization header.
# This can conflict with Basic auth often used on test environments.
# For that reason we also allow X-Authorization which take precedence
# over the regular Authorization header.
- coalesce:
    _output: /authorization
    items:
      - /headers/x-authorization
      - /headers/authorization

- if:
    left: /authorization
    then:
      - static:
          _output: /filters
          value: {}
      - substring:
          _output: /filters/token
          input: /authorization
          start: 7
      - date:
          _output: /filters/expires_gt
          format: X
      - select:
          _output: /tokens
          model: OauthAccessToken
          filters: /filters
          limit: 1
          selections:
            items:
              id:
              client:
                id:
              expires:
              user:
                id:
                name:
                scope:
              scope:
      - if:
          left: /tokens/items/0
          then:
            - object:
                _output: /data
                id: /tokens/items/0/user/id
                name: /tokens/items/0/user/name
                client: /tokens/items/0/client
            - object:
                _output: /data/token
                id: /tokens/items/0/id
                expires: /tokens/items/0/expires
            - scope-intersection:
                _output: /data/token/scope
                left: /tokens/items/0/scope
                right: /tokens/items/0/user/scope
